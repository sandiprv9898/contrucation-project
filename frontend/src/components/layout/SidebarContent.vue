<template>
  <div class="flex flex-col h-full">
    <!-- Logo/Brand -->
    <div class="flex items-center justify-center h-16 px-4 bg-orange-600">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center">
            <span class="text-orange-600 font-bold text-lg">üèóÔ∏è</span>
          </div>
        </div>
        <div class="ml-3 text-white">
          <h1 class="text-lg font-bold">Construction</h1>
          <p class="text-xs text-orange-100">Management Platform</p>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
      <!-- Main Navigation -->
      <div class="space-y-1">
        <SidebarLink
          v-for="item in mainNavigation"
          :key="item.name"
          :to="item.to"
          :icon="item.icon"
          :name="item.name"
          :badge="item.badge"
          @navigate="$emit('navigate')"
        />
      </div>

      <!-- Management Section -->
      <div v-if="canViewManagementSection" class="pt-6">
        <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
          Management
        </h3>
        <div class="mt-2 space-y-1">
          <SidebarLink
            v-for="item in managementNavigation"
            :key="item.name"
            :to="item.to"
            :icon="item.icon"
            :name="item.name"
            :badge="item.badge"
            @navigate="$emit('navigate')"
          />
        </div>
      </div>

      <!-- Administration Section -->
      <div v-if="canViewAdminSection" class="pt-6">
        <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
          Administration
        </h3>
        <div class="mt-2 space-y-1">
          <SidebarLink
            v-for="item in adminNavigation"
            :key="item.name"
            :to="item.to"
            :icon="item.icon"
            :name="item.name"
            :badge="item.badge"
            @navigate="$emit('navigate')"
          />
        </div>
      </div>

      <!-- Reports Section -->
      <div v-if="canViewReports" class="pt-6">
        <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
          Reports & Analytics
        </h3>
        <div class="mt-2 space-y-1">
          <SidebarLink
            v-for="item in reportsNavigation"
            :key="item.name"
            :to="item.to"
            :icon="item.icon"
            :name="item.name"
            :badge="item.badge"
            @navigate="$emit('navigate')"
          />
        </div>
      </div>
    </nav>

    <!-- User Profile Section -->
    <div class="flex-shrink-0 px-4 py-4 border-t border-gray-200">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <img
            v-if="currentUser?.avatar_url"
            :src="currentUser.avatar_url"
            :alt="currentUser.name"
            class="w-8 h-8 rounded-full"
          >
          <div
            v-else
            class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center"
          >
            <span class="text-orange-600 font-medium text-sm">
              {{ currentUser?.name?.charAt(0).toUpperCase() }}
            </span>
          </div>
        </div>
        <div class="ml-3 flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate">
            {{ currentUser?.name }}
          </p>
          <p class="text-xs text-gray-500 capitalize truncate">
            {{ currentUser?.role?.replace('_', ' ') }}
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useAuthStore } from '@/modules/auth'
import { useUserPermissions } from '@/modules/users'
import SidebarLink from './SidebarLink.vue'

defineOptions({ name: 'SidebarContent' })

defineEmits<{
  navigate: []
}>()

const authStore = useAuthStore()
const { hasPermission } = useUserPermissions()

const currentUser = computed(() => authStore.currentUser)

// Permission checks
const canViewManagementSection = computed(() => 
  hasPermission('canViewProjects') || 
  hasPermission('canManageProjects') ||
  hasPermission('canAssignTasks')
)

const canViewAdminSection = computed(() => 
  hasPermission('canManageUsers') || 
  hasPermission('canManageCompany')
)

const canViewReports = computed(() => 
  hasPermission('canViewReports')
)

// Navigation items
const mainNavigation = computed(() => [
  {
    name: 'Dashboard',
    to: '/dashboard',
    icon: 'üè†',
  },
  {
    name: 'Projects',
    to: '/projects',
    icon: 'üìã',
    badge: '12', // This could be dynamic
  },
  {
    name: 'Tasks',
    to: '/tasks',
    icon: '‚úÖ',
    badge: '8',
  },
  {
    name: 'Calendar',
    to: '/calendar',
    icon: 'üìÖ',
  },
  {
    name: 'Documents',
    to: '/documents',
    icon: 'üìÑ',
  },
])

const managementNavigation = computed(() => {
  const items = []
  
  if (hasPermission('canViewUsers') && !hasPermission('canManageUsers')) {
    items.push({
      name: 'Team Members',
      to: '/users',
      icon: 'üë•',
    })
  }
  
  if (hasPermission('canManageProjects')) {
    items.push({
      name: 'Project Settings',
      to: '/projects/settings',
      icon: '‚öôÔ∏è',
    })
  }
  
  if (hasPermission('canAssignTasks')) {
    items.push({
      name: 'Task Assignment',
      to: '/tasks/assign',
      icon: 'üìù',
    })
  }
  
  return items
})

const adminNavigation = computed(() => {
  const items = []
  
  if (hasPermission('canManageUsers')) {
    items.push({
      name: 'User Management',
      to: '/users',
      icon: 'üë§',
    })
  }
  
  if (hasPermission('canManageCompany')) {
    items.push({
      name: 'Company Settings',
      to: '/admin/company',
      icon: 'üè¢',
    })
    items.push({
      name: 'System Settings',
      to: '/admin/settings',
      icon: '‚öôÔ∏è',
    })
  }
  
  return items
})

const reportsNavigation = computed(() => 
  hasPermission('canViewReports') ? [
    {
      name: 'Project Reports',
      to: '/reports/projects',
      icon: 'üìä',
    },
    {
      name: 'Time Tracking',
      to: '/reports/time',
      icon: '‚è±Ô∏è',
    },
    {
      name: 'Cost Analysis',
      to: '/reports/costs',
      icon: 'üí∞',
    },
    {
      name: 'Performance',
      to: '/reports/performance',
      icon: 'üìà',
    },
  ] : []
)
</script>